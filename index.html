<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Almoxarifado – Peças de Manutenção</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f3f4f6;
      color: #111827;
    }
    header {
      background: #0ea5e9;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
    }
    nav a {
      color: white;
      text-decoration: none;
      margin-left: 15px;
      font-weight: bold;
      font-size: 14px;
    }
    .container {
      padding: 15px;
    }
    .cards {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    .card {
      background: white;
      padding: 10px 12px;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      min-width: 160px;
      flex: 1;
    }
    .card-title {
      font-size: 12px;
      color: #6b7280;
    }
    .card-value {
      font-size: 20px;
      font-weight: bold;
      margin-top: 4px;
    }
    .card-value.critico { color: #dc2626; }

    .top-panel {
      display: flex;
      gap: 15px;
      align-items: flex-start;
    }
    .left-panel {
      flex: 2;
      min-width: 0;
    }
    .right-panel {
      flex: 1;
      min-width: 260px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      padding: 10px;
    }

    .filtros {
      margin-bottom: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .filtros input, .filtros select {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 13px;
    }
    .btn {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      font-size: 13px;
      cursor: pointer;
    }
    .btn-primary {
      background: #0ea5e9;
      color: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      font-size: 13px;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }
    th {
      background: #e5f3fb;
      font-size: 12px;
      color: #374151;
    }
    tr:hover {
      background: #f9fafb;
      cursor: pointer;
    }
    .status-ok { color: #16a34a; font-weight: bold; }
    .status-alerta { color: #f97316; font-weight: bold; }
    .status-critico { color: #dc2626; font-weight: bold; }

    .item-image {
      width: 100%;
      max-height: 220px;
      object-fit: contain;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }
    .image-placeholder {
      width: 100%;
      max-height: 220px;
      border-radius: 8px;
      border: 1px dashed #d1d5db;
      background: #f9fafb;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #9ca3af;
      font-size: 13px;
      text-align: center;
      padding: 20px;
    }
    .detail-title {
      font-size: 14px;
      font-weight: bold;
      margin: 8px 0 4px;
    }
    .detail-line {
      font-size: 13px;
      margin-bottom: 3px;
    }
    .detail-label {
      color: #6b7280;
      font-weight: 500;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: white;
      border-radius: 10px;
      padding: 15px;
      width: 100%;
      max-width: 520px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
    }
    .modal h2 {
      margin-top: 0;
      font-size: 16px;
    }
    .modal .form-row {
      display: flex;
      gap: 10px;
    }
    .modal label {
      font-size: 12px;
      color: #4b5563;
      display: block;
      margin-bottom: 2px;
    }
    .modal input, .modal select, .modal textarea {
      width: 100%;
      padding: 6px 8px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      margin-bottom: 8px;
    }
    .modal textarea {
      resize: vertical;
      min-height: 60px;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 5px;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }

    @media (max-width: 900px) {
      .top-panel {
        flex-direction: column;
      }
      .right-panel {
        order: -1;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Almoxarifado – Peças de Manutenção</h1>
    <nav>
      <a href="#">Itens</a>
      <a href="#">Movimentações</a>
      <a href="#">Relatórios</a>
    </nav>
  </header>

  <div class="container">
    <!-- Cards resumo -->
    <div class="cards">
      <div class="card">
        <div class="card-title">Total de itens (filtrados)</div>
        <div class="card-value" id="card-total-itens">0</div>
      </div>
      <div class="card">
        <div class="card-title">Abaixo do mínimo</div>
        <div class="card-value critico" id="card-abaixo-minimo">0</div>
      </div>
      <div class="card">
        <div class="card-title">Itens críticos (Alta criticidade)</div>
        <div class="card-value" id="card-criticos">0</div>
      </div>
    </div>

    <div class="top-panel">
      <!-- Lista de itens -->
      <div class="left-panel">
        <div class="filtros">
          <input type="text" id="filtro-busca" placeholder="Buscar por código ou descrição">
          <select id="filtro-setor">
            <option value="">Setor</option>
            <option value="CROMAGEM">CROMAGEM</option>
            <option value="MANUTENÇÃO">MANUTENÇÃO</option>
            <option value="METALURGICA">METALURGICA</option>
            <option value="ENCABAGEM">ENCABAGEM</option>
            <option value="SERRALHEIRO">SERRALHEIRO</option>
          </select>
          <select id="filtro-criticidade">
            <option value="">Criticidade</option>
            <option value="Alta">Alta</option>
            <option value="Média">Média</option>
            <option value="Baixa">Baixa</option>
          </select>
          <button class="btn btn-primary" id="btn-novo-item">+ Novo item</button>
        </div>

        <table>
          <thead>
            <tr>
              <th>Código</th>
              <th>Descrição</th>
              <th>Setor</th>
              <th>Estoque</th>
              <th>Mínimo</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="tabela-itens">
            <!-- Linhas via JS -->
          </tbody>
        </table>
      </div>

      <!-- Detalhes + imagem -->
      <div class="right-panel">
        <div id="imagem-container">
          <div class="image-placeholder" id="sem-imagem">
            Nenhum item selecionado<br>ou item sem imagem.
          </div>
          <img id="imagem-item" class="item-image" src="" alt="" style="display:none;">
        </div>

        <div id="detalhes-item" style="margin-top: 8px;">
          <div class="detail-title" id="detalhe-descricao">Selecione um item…</div>
          <div class="detail-line"><span class="detail-label">Código:</span> <span id="detalhe-codigo">-</span></div>
          <div class="detail-line"><span class="detail-label">Setor:</span> <span id="detalhe-setor">-</span></div>
          <div class="detail-line"><span class="detail-label">Criticidade:</span> <span id="detalhe-criticidade">-</span></div>
          <div class="detail-line"><span class="detail-label">Estoque atual:</span> <span id="detalhe-estoque">-</span></div>
          <div class="detail-line"><span class="detail-label">Estoque mínimo:</span> <span id="detalhe-minimo">-</span></div>
          <div class="detail-line"><span class="detail-label">Observações:</span> <span id="detalhe-obs">-</span></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Novo Item -->
  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal">
      <h2>Novo item de almoxarifado</h2>
      <form id="form-novo-item">
        <div class="form-row">
          <div style="flex:1;">
            <label for="campo-codigo">Código interno</label>
            <input type="text" id="campo-codigo" required>
          </div>
        </div>

        <label for="campo-descricao">Descrição</label>
        <input type="text" id="campo-descricao" required>

        <div class="form-row">
          <div style="flex:1;">
            <label for="campo-setor">Setor</label>
            <select id="campo-setor" required>
              <option value="">Selecione…</option>
              <option value="CROMAGEM">CROMAGEM</option>
              <option value="MANUTENÇÃO">MANUTENÇÃO</option>
              <option value="METALURGICA">METALURGICA</option>
              <option value="ENCABAGEM">ENCABAGEM</option>
              <option value="SERRALHEIRO">SERRALHEIRO</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div style="flex:1;">
            <label for="campo-estoque">Estoque atual</label>
            <input type="number" id="campo-estoque" value="0">
          </div>
          <div style="flex:1;">
            <label for="campo-minimo">Estoque mínimo</label>
            <input type="number" id="campo-minimo" value="0">
          </div>
        </div>

        <div class="form-row">
          <div style="flex:1;">
            <label for="campo-criticidade">Criticidade</label>
            <select id="campo-criticidade">
              <option value="Baixa">Baixa</option>
              <option value="Média">Média</option>
              <option value="Alta">Alta</option>
            </select>
          </div>
        </div>

        <label for="campo-obs">Observações</label>
        <textarea id="campo-obs" placeholder="Detalhes importantes da peça…"></textarea>

        <label for="campo-imagem">Imagem do produto</label>
        <input type="file" id="campo-imagem" accept="image/*">

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="btn-cancelar-modal">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar item</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase + Lógica JS -->
  <script type="module">
    // Imports Firebase via CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-storage.js";

    // Config do seu projeto
    const firebaseConfig = {
      apiKey: "AIzaSyBM3huaVIYn2bqrrzupYTQBqFnOtSY6Zr0",
      authDomain: "almoxarifado-e9992.firebaseapp.com",
      projectId: "almoxarifado-e9992",
      storageBucket: "almoxarifado-e9992.firebasestorage.app",
      messagingSenderId: "1035781414746",
      appId: "1:1035781414746:web:89934cb0c0ef81b9c85d63"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    const colItens = collection(db, "itens_almox");

    // Elementos da página
    const tabelaItens = document.getElementById("tabela-itens");
    const filtroBusca = document.getElementById("filtro-busca");
    const filtroSetor = document.getElementById("filtro-setor");
    const filtroCrit = document.getElementById("filtro-criticidade");

    const cardTotal = document.getElementById("card-total-itens");
    const cardAbaixoMin = document.getElementById("card-abaixo-minimo");
    const cardCriticos = document.getElementById("card-criticos");

    const imgItem = document.getElementById("imagem-item");
    const semImagem = document.getElementById("sem-imagem");

    const detDesc = document.getElementById("detalhe-descricao");
    const detCodigo = document.getElementById("detalhe-codigo");
    const detSetor = document.getElementById("detalhe-setor");
    const detCrit = document.getElementById("detalhe-criticidade");
    const detEst = document.getElementById("detalhe-estoque");
    const detMin = document.getElementById("detalhe-minimo");
    const detObs = document.getElementById("detalhe-obs");

    const btnNovoItem = document.getElementById("btn-novo-item");
    const modalBackdrop = document.getElementById("modal-backdrop");
    const btnCancelarModal = document.getElementById("btn-cancelar-modal");
    const formNovoItem = document.getElementById("form-novo-item");
    const campoImagem = document.getElementById("campo-imagem");

    let itensCache = [];   // itens carregados do Firestore
    let itemSelecionado = null;

    // Modal
    function abrirModal() {
      formNovoItem.reset();
      // defaults
      document.getElementById("campo-estoque").value = 0;
      document.getElementById("campo-minimo").value = 0;
      document.getElementById("campo-criticidade").value = "Baixa";
      modalBackdrop.style.display = "flex";
    }
    function fecharModal() {
      modalBackdrop.style.display = "none";
    }
    btnNovoItem.addEventListener("click", abrirModal);
    btnCancelarModal.addEventListener("click", fecharModal);
    modalBackdrop.addEventListener("click", (e) => {
      if (e.target === modalBackdrop) fecharModal();
    });

    // Status estoque (classe + texto)
    function getStatusEstoque(item) {
      const estoque = Number(item.estoque || 0);
      const minimo = Number(item.minimo || 0);
      if (minimo <= 0) return { texto: "Sem mínimo", classe: "status-ok" };
      if (estoque <= 0) return { texto: "Sem estoque", classe: "status-critico" };
      if (estoque < minimo) return { texto: "Abaixo do mínimo", classe: "status-critico" };
      if (estoque === minimo) return { texto: "No mínimo", classe: "status-alerta" };
      if (estoque < minimo * 1.3) return { texto: "Próximo do mínimo", classe: "status-alerta" };
      return { texto: "OK", classe: "status-ok" };
    }

    // Renderizar tabela com filtros
    function renderTabela() {
      const busca = (filtroBusca.value || "").toLowerCase();
      const setor = filtroSetor.value;
      const crit = filtroCrit.value;

      tabelaItens.innerHTML = "";

      let total = 0;
      let abaixoMin = 0;
      let criticos = 0;

      itensCache.forEach((item) => {
        let ok = true;

        if (busca) {
          const texto = (
            (item.codigo || "") + " " +
            (item.descricao || "")
          ).toLowerCase();
          if (!texto.includes(busca)) ok = false;
        }
        if (setor && item.setor !== setor) ok = false;
        if (crit && item.criticidade !== crit) ok = false;

        if (!ok) return;

        total++;
        const status = getStatusEstoque(item);
        if (status.classe === "status-critico") abaixoMin++;
        if (item.criticidade === "Alta") criticos++;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.codigo || ""}</td>
          <td>${item.descricao || ""}</td>
          <td>${item.setor || ""}</td>
          <td>${item.estoque ?? 0}</td>
          <td>${item.minimo ?? 0}</td>
          <td class="${status.classe}">${status.texto}</td>
        `;
        tr.addEventListener("click", () => selecionarItem(item));
        tabelaItens.appendChild(tr);
      });

      cardTotal.textContent = total;
      cardAbaixoMin.textContent = abaixoMin;
      cardCriticos.textContent = criticos;
    }

    // Detalhes + imagem ao lado
    function selecionarItem(item) {
      itemSelecionado = item;
      detDesc.textContent = item.descricao || "(sem descrição)";
      detCodigo.textContent = item.codigo || "-";
      detSetor.textContent = item.setor || "-";
      detCrit.textContent = item.criticidade || "-";
      detEst.textContent = item.estoque ?? "-";
      detMin.textContent = item.minimo ?? "-";
      detObs.textContent = item.obs || "-";

      if (item.imagemUrl) {
        imgItem.src = item.imagemUrl;
        imgItem.style.display = "block";
        semImagem.style.display = "none";
      } else {
        imgItem.style.display = "none";
        semImagem.style.display = "flex";
        semImagem.textContent = "Item sem imagem cadastrada.";
      }
    }

    // Listener realtime do Firestore
    const qItens = query(colItens, orderBy("descricao"));
    onSnapshot(qItens, (snapshot) => {
      itensCache = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      renderTabela();
    });

    filtroBusca.addEventListener("input", renderTabela);
    filtroSetor.addEventListener("change", renderTabela);
    filtroCrit.addEventListener("change", renderTabela);

    // Salvar novo item (com upload de imagem no Storage)
    formNovoItem.addEventListener("submit", async (e) => {
      e.preventDefault();

      const novoItem = {
        codigo: document.getElementById("campo-codigo").value.trim(),
        descricao: document.getElementById("campo-descricao").value.trim(),
        setor: document.getElementById("campo-setor").value || "",
        estoque: Number(document.getElementById("campo-estoque").value || 0),
        minimo: Number(document.getElementById("campo-minimo").value || 0),
        criticidade: document.getElementById("campo-criticidade").value || "Baixa",
        obs: document.getElementById("campo-obs").value.trim(),
        imagemUrl: ""
      };

      if (!novoItem.codigo || !novoItem.descricao || !novoItem.setor) {
        alert("Preencha código, descrição e setor.");
        return;
      }

      const arquivo = campoImagem.files[0];

      try {
        // Se tiver imagem, sobe pro Storage primeiro
        if (arquivo) {
          const caminho = `itens_almox/${Date.now()}_${arquivo.name}`;
          const storageRef = ref(storage, caminho);
          await uploadBytes(storageRef, arquivo);
          const url = await getDownloadURL(storageRef);
          novoItem.imagemUrl = url;
        }

        await addDoc(colItens, novoItem);
        fecharModal();
      } catch (err) {
        console.error("Erro ao salvar item:", err);
        alert("Erro ao salvar item. Veja o console para detalhes.");
      }
    });
  </script>
</body>
</html>
