<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <title>Almoxarifado ‚Äì Pe√ßas de Manuten√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f3f4f6;
      color: #111827;
    }
    header {
      background: #0ea5e9;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    header h1 {
      font-size: 18px;
      margin: 0;
    }
    nav a {
      color: white;
      text-decoration: none;
      margin-left: 15px;
      font-weight: bold;
      font-size: 14px;
      opacity: 0.9;
    }
    nav a.active {
      text-decoration: underline;
      opacity: 1;
    }
    .container {
      padding: 15px;
    }
    .cards {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 15px;
    }
    .card {
      background: white;
      padding: 10px 12px;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      min-width: 160px;
      flex: 1;
    }
    .card-title {
      font-size: 12px;
      color: #6b7280;
    }
    .card-value {
      font-size: 20px;
      font-weight: bold;
      margin-top: 4px;
    }
    .card-value.critico { color: #dc2626; }

    .top-panel {
      display: flex;
      gap: 15px;
      align-items: flex-start;
    }
    .left-panel {
      flex: 2;
      min-width: 0;
    }
    .right-panel {
      flex: 1;
      min-width: 260px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
      padding: 10px;
    }

    .filtros {
      margin-bottom: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    .filtros input, .filtros select {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      font-size: 13px;
    }
    .btn {
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      font-size: 13px;
      cursor: pointer;
    }
    .btn-primary {
      background: #0ea5e9;
      color: white;
    }
    .btn-secondary {
      background: #e5e7eb;
      color: #111827;
    }
    .btn-danger {
      background: #ef4444;
      color: white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 10px;
      overflow: hidden;
      font-size: 13px;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
    }
    th {
      background: #e5f3fb;
      font-size: 12px;
      color: #374151;
    }
    tr:hover {
      background: #f9fafb;
      cursor: pointer;
    }
    .status-ok { color: #16a34a; font-weight: bold; }
    .status-alerta { color: #f97316; font-weight: bold; }
    .status-critico { color: #dc2626; font-weight: bold; }

    .detail-title {
      font-size: 14px;
      font-weight: bold;
      margin: 8px 0 4px;
    }
    .detail-line {
      font-size: 13px;
      margin-bottom: 3px;
    }
    .detail-label {
      color: #6b7280;
      font-weight: 500;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }
    .modal {
      background: white;
      border-radius: 10px;
      padding: 15px;
      width: 100%;
      max-width: 520px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
    }
    .modal h2 {
      margin-top: 0;
      font-size: 16px;
    }
    .modal .form-row {
      display: flex;
      gap: 10px;
    }
    .modal label {
      font-size: 12px;
      color: #4b5563;
      display: block;
      margin-bottom: 2px;
    }
    .modal input, .modal select, .modal textarea {
      width: 100%;
      padding: 6px 8px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      margin-bottom: 8px;
    }
    .modal textarea {
      resize: vertical;
      min-height: 60px;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 5px;
    }

    @media (max-width: 900px) {
      .top-panel {
        flex-direction: column;
      }
      .right-panel {
        order: -1;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Almoxarifado ‚Äì Pe√ßas de Manuten√ß√£o</h1>
    <nav>
      <a href="#" id="nav-itens" class="active">Itens</a>
      <a href="#" id="nav-mov">Movimenta√ß√µes</a>
      <a href="#" id="nav-rel">Relat√≥rios</a>
      <a href="relatorios.html" id="nav-rel-page">P√°gina de Relat√≥rios</a>
    </nav>
  </header>

  <div class="container">
    <!-- VIEW ITENS -->
    <div id="view-itens">
      <!-- Cards resumo -->
      <div class="cards">
        <div class="card">
          <div class="card-title">Total de itens (filtrados)</div>
          <div class="card-value" id="card-total-itens">0</div>
        </div>
        <div class="card">
          <div class="card-title">Abaixo do m√≠nimo</div>
          <div class="card-value critico" id="card-abaixo-minimo">0</div>
        </div>
        <div class="card">
          <div class="card-title">Itens cr√≠ticos (Alta criticidade)</div>
          <div class="card-value" id="card-criticos">0</div>
        </div>
      </div>

      <div class="top-panel">
        <!-- Lista de itens -->
        <div class="left-panel">
          <div class="filtros">
            <input type="text" id="filtro-busca" placeholder="Buscar por c√≥digo ou descri√ß√£o">
            <select id="filtro-setor">
              <option value="">Setor</option>
              <option value="CROMAGEM">CROMAGEM</option>
              <option value="MANUTEN√á√ÉO">MANUTEN√á√ÉO</option>
              <option value="METALURGICA">METALURGICA</option>
              <option value="ENCABAGEM">ENCABAGEM</option>
              <option value="SERRALHEIRO">SERRALHEIRO</option>
            </select>
            <select id="filtro-criticidade">
              <option value="">Criticidade</option>
              <option value="Alta">Alta</option>
              <option value="M√©dia">M√©dia</option>
              <option value="Baixa">Baixa</option>
            </select>
            <button class="btn btn-primary" id="btn-novo-item">+ Novo item</button>
          </div>

          <table>
            <thead>
              <tr>
                <th>C√≥digo</th>
                <th>Descri√ß√£o</th>
                <th>Setor</th>
                <th>Estoque</th>
                <th>M√≠nimo</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="tabela-itens">
              <!-- Linhas via JS -->
            </tbody>
          </table>
        </div>

        <!-- Detalhes + a√ß√µes -->
        <div class="right-panel">
          <div id="detalhes-item" style="margin-top: 8px;">
            <div class="detail-title" id="detalhe-descricao">Selecione um item‚Ä¶</div>
            <div class="detail-line"><span class="detail-label">C√≥digo:</span> <span id="detalhe-codigo">-</span></div>
            <div class="detail-line"><span class="detail-label">Setor:</span> <span id="detalhe-setor">-</span></div>
            <div class="detail-line"><span class="detail-label">Criticidade:</span> <span id="detalhe-criticidade">-</span></div>
            <div class="detail-line"><span class="detail-label">Estoque atual:</span> <span id="detalhe-estoque">-</span></div>
            <div class="detail-line"><span class="detail-label">Estoque m√≠nimo:</span> <span id="detalhe-minimo">-</span></div>
            <div class="detail-line"><span class="detail-label">Observa√ß√µes:</span> <span id="detalhe-obs">-</span></div>
          </div>
          <button
            class="btn btn-secondary"
            id="btn-editar-item"
            style="margin-top:10px;width:100%;"
            disabled
          >
            Editar item selecionado
          </button>
          <button
            class="btn btn-danger"
            id="btn-excluir-item"
            style="margin-top:6px;width:100%;"
            disabled
          >
            Excluir item selecionado
          </button>
        </div>
      </div>
    </div>

    <!-- VIEW MOVIMENTA√á√ïES -->
    <div id="view-mov" style="display:none;">
      <div class="cards">
        <div class="card">
          <div class="card-title">Movimenta√ß√µes (√∫ltimas filtradas)</div>
          <div class="card-value" id="card-total-mov">0</div>
        </div>
      </div>

      <div class="filtros">
        <input type="text" id="mov-filtro-busca" placeholder="Buscar por c√≥digo, descri√ß√£o ou respons√°vel">
        <select id="mov-filtro-tipo">
          <option value="">Tipo</option>
          <option value="Entrada">Entrada</option>
          <option value="Sa√≠da">Sa√≠da</option>
          <option value="Ajuste">Ajuste</option>
        </select>
        <select id="mov-filtro-setor">
          <option value="">Setor</option>
          <option value="CROMAGEM">CROMAGEM</option>
          <option value="MANUTEN√á√ÉO">MANUTEN√á√ÉO</option>
          <option value="METALURGICA">METALURGICA</option>
          <option value="ENCABAGEM">ENCABAGEM</option>
          <option value="SERRALHEIRO">SERRALHEIRO</option>
        </select>
        <select id="mov-filtro-motivo">
          <option value="">Motivo</option>
          <option value="Preventiva">Preventiva</option>
          <option value="Corretiva">Corretiva</option>
          <option value="Projeto">Projeto</option>
          <option value="Invent√°rio">Invent√°rio</option>
          <option value="Outro">Outro</option>
        </select>
        <button class="btn btn-primary" id="btn-nova-mov">+ Nova movimenta√ß√£o</button>
      </div>

      <table>
        <thead>
          <tr>
            <th>Data/Hora</th>
            <th>C√≥digo</th>
            <th>Descri√ß√£o</th>
            <th>Tipo</th>
            <th>Qtd</th>
            <th>Setor</th>
            <th>Respons√°vel</th>
            <th>Motivo</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tabela-mov">
          <!-- Linhas via JS -->
        </tbody>
      </table>
    </div>

    <!-- VIEW RELAT√ìRIOS (placeholder) -->
    <div id="view-rel" style="display:none;">
      <p>Relat√≥rios em breve üòÑ (podemos montar depois com base em itens e movimenta√ß√µes).</p>
    </div>
  </div>

  <!-- Modal Novo/Editar Item -->
  <div class="modal-backdrop" id="modal-backdrop">
    <div class="modal">
      <h2 id="titulo-modal-item">Novo item de almoxarifado</h2>
      <form id="form-novo-item">
        <div class="form-row">
          <div style="flex:1;">
            <label for="campo-codigo">C√≥digo interno</label>
            <input type="text" id="campo-codigo" required>
          </div>
        </div>

        <label for="campo-descricao">Descri√ß√£o</label>
        <input type="text" id="campo-descricao" required>

        <div class="form-row">
          <div style="flex:1;">
            <label for="campo-setor">Setor</label>
            <select id="campo-setor" required>
              <option value="">Selecione‚Ä¶</option>
              <option value="CROMAGEM">CROMAGEM</option>
              <option value="MANUTEN√á√ÉO">MANUTEN√á√ÉO</option>
              <option value="METALURGICA">METALURGICA</option>
              <option value="ENCABAGEM">ENCABAGEM</option>
              <option value="SERRALHEIRO">SERRALHEIRO</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div style="flex:1;">
            <label for="campo-estoque">Estoque atual</label>
            <input type="number" id="campo-estoque" value="0">
          </div>
          <div style="flex:1;">
            <label for="campo-minimo">Estoque m√≠nimo</label>
            <input type="number" id="campo-minimo" value="0">
          </div>
        </div>

        <div class="form-row">
          <div style="flex:1;">
            <label for="campo-criticidade">Criticidade</label>
            <select id="campo-criticidade">
              <option value="Baixa">Baixa</option>
              <option value="M√©dia">M√©dia</option>
              <option value="Alta">Alta</option>
            </select>
          </div>
        </div>

        <label for="campo-obs">Observa√ß√µes</label>
        <textarea id="campo-obs" placeholder="Detalhes importantes da pe√ßa‚Ä¶"></textarea>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="btn-cancelar-modal">Cancelar</button>
          <button type="submit" class="btn btn-primary" id="btn-salvar-item">Salvar item</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Nova Movimenta√ß√£o -->
  <div class="modal-backdrop" id="modal-backdrop-mov">
    <div class="modal">
      <h2>Nova movimenta√ß√£o</h2>
      <form id="form-nova-mov">
        <label for="mov-item">Item</label>
        <select id="mov-item" required></select>

        <div class="form-row">
          <div style="flex:1;">
            <label for="mov-tipo">Tipo</label>
            <select id="mov-tipo" required>
              <option value="Entrada">Entrada</option>
              <option value="Sa√≠da">Sa√≠da</option>
              <option value="Ajuste">Ajuste</option>
            </select>
          </div>
          <div style="flex:1;">
            <label for="mov-quantidade">Quantidade</label>
            <input type="number" id="mov-quantidade" value="1" min="0" required>
          </div>
        </div>

        <div class="form-row">
          <div style="flex:1;">
            <label for="mov-setor">Setor</label>
            <select id="mov-setor">
              <option value="">(usar do item)</option>
              <option value="CROMAGEM">CROMAGEM</option>
              <option value="MANUTEN√á√ÉO">MANUTEN√á√ÉO</option>
              <option value="METALURGICA">METALURGICA</option>
              <option value="ENCABAGEM">ENCABAGEM</option>
              <option value="SERRALHEIRO">SERRALHEIRO</option>
            </select>
          </div>
          <div style="flex:1;">
            <label for="mov-responsavel">Respons√°vel</label>
            <input type="text" id="mov-responsavel" placeholder="Quem retirou / lan√ßou">
          </div>
        </div>

        <div class="form-row">
          <div style="flex:1;">
            <label for="mov-motivo">Motivo</label>
            <select id="mov-motivo">
              <option value="">Selecione‚Ä¶</option>
              <option value="Preventiva">Preventiva</option>
              <option value="Corretiva">Corretiva</option>
              <option value="Projeto">Projeto</option>
              <option value="Invent√°rio">Invent√°rio</option>
              <option value="Outro">Outro</option>
            </select>
          </div>
        </div>

        <label for="mov-obs">Observa√ß√µes</label>
        <textarea id="mov-obs" placeholder="Detalhes da movimenta√ß√£o‚Ä¶"></textarea>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" id="btn-cancelar-modal-mov">Cancelar</button>
          <button type="submit" class="btn btn-primary">Salvar movimenta√ß√£o</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase + L√≥gica JS -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, onSnapshot, query, orderBy,
      doc, updateDoc, serverTimestamp, deleteDoc
    } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBM3huaVIYn2bqrrzupYTQBqFnOtSY6Zr0",
      authDomain: "almoxarifado-e9992.firebaseapp.com",
      projectId: "almoxarifado-e9992",
      storageBucket: "almoxarifado-e9992.firebasestorage.app",
      messagingSenderId: "1035781414746",
      appId: "1:1035781414746:web:89934cb0c0ef81b9c85d63"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const colItens = collection(db, "itens_almox");
    const colMov = collection(db, "movimentacoes_almox");

    // NAV
    const navItens = document.getElementById("nav-itens");
    const navMov = document.getElementById("nav-mov");
    const navRel = document.getElementById("nav-rel");
    const viewItens = document.getElementById("view-itens");
    const viewMov = document.getElementById("view-mov");
    const viewRel = document.getElementById("view-rel");

    function setView(view) {
      viewItens.style.display = view === "itens" ? "block" : "none";
      viewMov.style.display = view === "mov" ? "block" : "none";
      viewRel.style.display = view === "rel" ? "block" : "none";

      navItens.classList.toggle("active", view === "itens");
      navMov.classList.toggle("active", view === "mov");
      navRel.classList.toggle("active", view === "rel");
    }

    navItens.addEventListener("click", (e) => { e.preventDefault(); setView("itens"); });
    navMov.addEventListener("click", (e) => { e.preventDefault(); setView("mov"); });
    navRel.addEventListener("click", (e) => { e.preventDefault(); setView("rel"); });

    // ITENS
    const tabelaItens = document.getElementById("tabela-itens");
    const filtroBusca = document.getElementById("filtro-busca");
    const filtroSetor = document.getElementById("filtro-setor");
    const filtroCrit = document.getElementById("filtro-criticidade");

    const cardTotal = document.getElementById("card-total-itens");
    const cardAbaixoMin = document.getElementById("card-abaixo-minimo");
    const cardCriticos = document.getElementById("card-criticos");

    const detDesc = document.getElementById("detalhe-descricao");
    const detCodigo = document.getElementById("detalhe-codigo");
    const detSetor = document.getElementById("detalhe-setor");
    const detCrit = document.getElementById("detalhe-criticidade");
    const detEst = document.getElementById("detalhe-estoque");
    const detMin = document.getElementById("detalhe-minimo");
    const detObs = document.getElementById("detalhe-obs");

    const btnNovoItem = document.getElementById("btn-novo-item");
    const modalBackdrop = document.getElementById("modal-backdrop");
    const btnCancelarModal = document.getElementById("btn-cancelar-modal");
    const formNovoItem = document.getElementById("form-novo-item");
    const tituloModalItem = document.getElementById("titulo-modal-item");
    const btnSalvarItem = document.getElementById("btn-salvar-item");
    const btnEditarItem = document.getElementById("btn-editar-item");
    const btnExcluirItem = document.getElementById("btn-excluir-item");

    // MOV
    const tabelaMov = document.getElementById("tabela-mov");
    const cardTotalMov = document.getElementById("card-total-mov");
    const movFiltroBusca = document.getElementById("mov-filtro-busca");
    const movFiltroTipo = document.getElementById("mov-filtro-tipo");
    const movFiltroSetor = document.getElementById("mov-filtro-setor");
    const movFiltroMotivo = document.getElementById("mov-filtro-motivo");
    const btnNovaMov = document.getElementById("btn-nova-mov");
    const modalBackdropMov = document.getElementById("modal-backdrop-mov");
    const btnCancelarModalMov = document.getElementById("btn-cancelar-modal-mov");
    const formNovaMov = document.getElementById("form-nova-mov");
    const movItemSelect = document.getElementById("mov-item");

    const movTipo = document.getElementById("mov-tipo");
    const movQuantidade = document.getElementById("mov-quantidade");
    const movSetor = document.getElementById("mov-setor");
    const movResponsavel = document.getElementById("mov-responsavel");
    const movMotivo = document.getElementById("mov-motivo");
    const movObs = document.getElementById("mov-obs");

    let itensCache = [];
    let itemSelecionado = null;
    let movCache = [];
    let modoEdicaoItem = false;

    // ---------- MODAL ITENS ----------
    function abrirModalItemNovo() {
      modoEdicaoItem = false;
      tituloModalItem.textContent = "Novo item de almoxarifado";
      btnSalvarItem.textContent = "Salvar item";
      formNovoItem.reset();
      document.getElementById("campo-estoque").value = 0;
      document.getElementById("campo-minimo").value = 0;
      document.getElementById("campo-criticidade").value = "Baixa";
      modalBackdrop.style.display = "flex";
    }

    function abrirModalItemEdicao() {
      if (!itemSelecionado) {
        alert("Selecione um item para editar.");
        return;
      }
      modoEdicaoItem = true;
      tituloModalItem.textContent = "Editar item de almoxarifado";
      btnSalvarItem.textContent = "Salvar altera√ß√µes";

      document.getElementById("campo-codigo").value = itemSelecionado.codigo || "";
      document.getElementById("campo-descricao").value = itemSelecionado.descricao || "";
      document.getElementById("campo-setor").value = itemSelecionado.setor || "";
      document.getElementById("campo-estoque").value = itemSelecionado.estoque ?? 0;
      document.getElementById("campo-minimo").value = itemSelecionado.minimo ?? 0;
      document.getElementById("campo-criticidade").value = itemSelecionado.criticidade || "Baixa";
      document.getElementById("campo-obs").value = itemSelecionado.obs || "";

      modalBackdrop.style.display = "flex";
    }

    function fecharModalItem() {
      modalBackdrop.style.display = "none";
    }

    btnNovoItem.addEventListener("click", abrirModalItemNovo);
    btnEditarItem.addEventListener("click", abrirModalItemEdicao);
    btnCancelarModal.addEventListener("click", fecharModalItem);
    modalBackdrop.addEventListener("click", (e) => {
      if (e.target === modalBackdrop) fecharModalItem();
    });

    // ---------- MODAL MOV ----------
    function preencherSelectItensMov() {
      movItemSelect.innerHTML = "";
      if (itensCache.length === 0) {
        const opt = document.createElement("option");
        opt.value = "";
        opt.textContent = "Nenhum item cadastrado";
        movItemSelect.appendChild(opt);
        return;
      }
      const optPadrao = document.createElement("option");
      optPadrao.value = "";
      optPadrao.textContent = "Selecione um item‚Ä¶";
      movItemSelect.appendChild(optPadrao);

      itensCache.forEach((item) => {
        const opt = document.createElement("option");
        opt.value = item.id;
        opt.textContent = `${item.codigo || "S/C"} - ${item.descricao || ""}`;
        movItemSelect.appendChild(opt);
      });
    }

    function abrirModalMov() {
      preencherSelectItensMov();
      formNovaMov.reset();
      movQuantidade.value = 1;
      movTipo.value = "Entrada";
      modalBackdropMov.style.display = "flex";
    }

    function fecharModalMov() {
      modalBackdropMov.style.display = "none";
    }

    btnNovaMov.addEventListener("click", abrirModalMov);
    btnCancelarModalMov.addEventListener("click", fecharModalMov);
    modalBackdropMov.addEventListener("click", (e) => {
      if (e.target === modalBackdropMov) fecharModalMov();
    });

    // ---------- STATUS ESTOQUE ----------
    function getStatusEstoque(item) {
      const estoque = Number(item.estoque || 0);
      const minimo = Number(item.minimo || 0);
      if (minimo <= 0) return { texto: "Sem m√≠nimo", classe: "status-ok" };
      if (estoque <= 0) return { texto: "Sem estoque", classe: "status-critico" };
      if (estoque < minimo) return { texto: "Abaixo do m√≠nimo", classe: "status-critico" };
      if (estoque === minimo) return { texto: "No m√≠nimo", classe: "status-alerta" };
      if (estoque < minimo * 1.3) return { texto: "Pr√≥ximo do m√≠nimo", classe: "status-alerta" };
      return { texto: "OK", classe: "status-ok" };
    }

    // ---------- RENDER ITENS ----------
    function renderTabelaItens() {
      const busca = (filtroBusca.value || "").toLowerCase();
      const setor = filtroSetor.value;
      const crit = filtroCrit.value;

      tabelaItens.innerHTML = "";

      let total = 0;
      let abaixoMin = 0;
      let criticos = 0;

      itensCache.forEach((item) => {
        let ok = true;

        if (busca) {
          const texto = (
            (item.codigo || "") + " " +
            (item.descricao || "")
          ).toLowerCase();
          if (!texto.includes(busca)) ok = false;
        }
        if (setor && item.setor !== setor) ok = false;
        if (crit && item.criticidade !== crit) ok = false;

        if (!ok) return;

        total++;
        const status = getStatusEstoque(item);
        if (status.classe === "status-critico") abaixoMin++;
        if (item.criticidade === "Alta") criticos++;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${item.codigo || ""}</td>
          <td>${item.descricao || ""}</td>
          <td>${item.setor || ""}</td>
          <td>${item.estoque ?? 0}</td>
          <td>${item.minimo ?? 0}</td>
          <td class="${status.classe}">${status.texto}</td>
        `;
        tr.addEventListener("click", () => selecionarItem(item));
        tabelaItens.appendChild(tr);
      });

      cardTotal.textContent = total;
      cardAbaixoMin.textContent = abaixoMin;
      cardCriticos.textContent = criticos;
    }

    function selecionarItem(item) {
      itemSelecionado = item;
      detDesc.textContent = item.descricao || "(sem descri√ß√£o)";
      detCodigo.textContent = item.codigo || "-";
      detSetor.textContent = item.setor || "-";
      detCrit.textContent = item.criticidade || "-";
      detEst.textContent = item.estoque ?? "-";
      detMin.textContent = item.minimo ?? "-";
      detObs.textContent = item.obs || "-";
      btnEditarItem.disabled = false;
      btnExcluirItem.disabled = false;
    }

    function limparSelecao() {
      itemSelecionado = null;
      detDesc.textContent = "Selecione um item‚Ä¶";
      detCodigo.textContent = "-";
      detSetor.textContent = "-";
      detCrit.textContent = "-";
      detEst.textContent = "-";
      detMin.textContent = "-";
      detObs.textContent = "-";
      btnEditarItem.disabled = true;
      btnExcluirItem.disabled = true;
    }

    // Listener itens
    const qItens = query(colItens, orderBy("descricao"));
    onSnapshot(qItens, (snapshot) => {
      itensCache = snapshot.docs.map(docSnap => ({
        id: docSnap.id,
        ...docSnap.data()
      }));
      renderTabelaItens();
    });

    filtroBusca.addEventListener("input", renderTabelaItens);
    filtroSetor.addEventListener("change", renderTabelaItens);
    filtroCrit.addEventListener("change", renderTabelaItens);

    // Salvar (novo ou edi√ß√£o) item
    formNovoItem.addEventListener("submit", async (e) => {
      e.preventDefault();

      const novoItem = {
        codigo: document.getElementById("campo-codigo").value.trim(),
        descricao: document.getElementById("campo-descricao").value.trim(),
        setor: document.getElementById("campo-setor").value || "",
        estoque: Number(document.getElementById("campo-estoque").value || 0),
        minimo: Number(document.getElementById("campo-minimo").value || 0),
        criticidade: document.getElementById("campo-criticidade").value || "Baixa",
        obs: document.getElementById("campo-obs").value.trim()
      };

      if (!novoItem.codigo || !novoItem.descricao || !novoItem.setor) {
        alert("Preencha c√≥digo, descri√ß√£o e setor.");
        return;
      }

      try {
        if (modoEdicaoItem && itemSelecionado) {
          const refItem = doc(db, "itens_almox", itemSelecionado.id);
          await updateDoc(refItem, novoItem);
        } else {
          await addDoc(colItens, novoItem);
        }
        fecharModalItem();
      } catch (err) {
        console.error("Erro ao salvar item:", err);
        alert("Erro ao salvar item. Veja o console para detalhes.");
      }
    });

    // Excluir item
    btnExcluirItem.addEventListener("click", async () => {
      if (!itemSelecionado) {
        alert("Nenhum item selecionado.");
        return;
      }

      const qtdMov = movCache.filter(m => m.itemId === itemSelecionado.id).length;
      let msg = `Tem certeza que deseja excluir o item:\n\n${itemSelecionado.codigo} - ${itemSelecionado.descricao}?`;
      if (qtdMov > 0) {
        msg += `\n\nAten√ß√£o: existem ${qtdMov} movimenta√ß√µe(s) registradas para este item. Elas N√ÉO ser√£o apagadas.`;
      }

      const ok = confirm(msg);
      if (!ok) return;

      try {
        const refItem = doc(db, "itens_almox", itemSelecionado.id);
        await deleteDoc(refItem);
        limparSelecao();
      } catch (err) {
        console.error("Erro ao excluir item:", err);
        alert("Erro ao excluir item. Veja o console para detalhes.");
      }
    });

    // ---------- MOVIMENTA√á√ïES ----------
    function formatarDataHora(ts) {
      if (!ts) return "-";
      let d;
      if (ts.toDate) d = ts.toDate();
      else d = new Date(ts);
      const dia = String(d.getDate()).padStart(2, "0");
      const mes = String(d.getMonth() + 1).padStart(2, "0");
      const ano = d.getFullYear();
      const hora = String(d.getHours()).padStart(2, "0");
      const min = String(d.getMinutes()).padStart(2, "0");
      return `${dia}/${mes}/${ano} ${hora}:${min}`;
    }

    function renderTabelaMov() {
      const busca = (movFiltroBusca.value || "").toLowerCase();
      const tipo = movFiltroTipo.value;
      const setor = movFiltroSetor.value;
      const motivo = movFiltroMotivo.value;

      tabelaMov.innerHTML = "";

      let total = 0;

      movCache.forEach((mov) => {
        let ok = true;

        if (busca) {
          const texto = (
            (mov.codigo || "") + " " +
            (mov.descricao || "") + " " +
            (mov.responsavel || "")
          ).toLowerCase();
          if (!texto.includes(busca)) ok = false;
        }
        if (tipo && mov.tipo !== tipo) ok = false;
        if (setor && mov.setor !== setor) ok = false;
        if (motivo && mov.motivo !== motivo) ok = false;

        if (!ok) return;

        total++;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${formatarDataHora(mov.dataHora)}</td>
          <td>${mov.codigo || ""}</td>
          <td>${mov.descricao || ""}</td>
          <td>${mov.tipo || ""}</td>
          <td>${mov.quantidade ?? 0}</td>
          <td>${mov.setor || ""}</td>
          <td>${mov.responsavel || ""}</td>
          <td>${mov.motivo || ""}</td>
        `;

        const tdAcao = document.createElement("td");
        const btnDel = document.createElement("button");
        btnDel.textContent = "Excluir";
        btnDel.className = "btn btn-danger";
        btnDel.style.fontSize = "11px";
        btnDel.addEventListener("click", (e) => {
          e.stopPropagation();
          excluirMovimentacao(mov);
        });
        tdAcao.appendChild(btnDel);
        tr.appendChild(tdAcao);

        tabelaMov.appendChild(tr);
      });

      cardTotalMov.textContent = total;
    }

    // Listener movimenta√ß√µes
    const qMov = query(colMov, orderBy("dataHora", "desc"));
    onSnapshot(qMov, (snapshot) => {
      movCache = snapshot.docs.map(docSnap => ({
        id: docSnap.id,
        ...docSnap.data()
      }));
      renderTabelaMov();
    });

    movFiltroBusca.addEventListener("input", renderTabelaMov);
    movFiltroTipo.addEventListener("change", renderTabelaMov);
    movFiltroSetor.addEventListener("change", renderTabelaMov);
    movFiltroMotivo.addEventListener("change", renderTabelaMov);

    // Salvar movimenta√ß√£o
    formNovaMov.addEventListener("submit", async (e) => {
      e.preventDefault();

      const itemId = movItemSelect.value;
      if (!itemId) {
        alert("Selecione um item.");
        return;
      }

      const item = itensCache.find(i => i.id === itemId);
      if (!item) {
        alert("Item n√£o encontrado.");
        return;
      }

      const tipo = movTipo.value;
      const qtd = Number(movQuantidade.value || 0);
      if (qtd < 0) {
        alert("Quantidade inv√°lida.");
        return;
      }

      const movSetorVal = movSetor.value || item.setor || "";
      const responsavel = movResponsavel.value.trim();
      const motivo = movMotivo.value || "";
      const obs = movObs.value.trim();

      const movDoc = {
        itemId: itemId,
        codigo: item.codigo || "",
        descricao: item.descricao || "",
        setor: movSetorVal,
        tipo: tipo,
        quantidade: qtd,
        responsavel: responsavel,
        motivo: motivo,
        obs: obs,
        dataHora: serverTimestamp()
      };

      try {
        let novoEstoque = Number(item.estoque || 0);
        if (tipo === "Entrada") {
          novoEstoque += qtd;
        } else if (tipo === "Sa√≠da") {
          novoEstoque -= qtd;
        } else if (tipo === "Ajuste") {
          novoEstoque = qtd;
        }

        if (novoEstoque < 0 && tipo !== "Ajuste") {
          const cont = confirm("Estoque ficaria negativo. Deseja continuar mesmo assim?");
          if (!cont) return;
        }

        const itemRef = doc(db, "itens_almox", itemId);
        await updateDoc(itemRef, { estoque: novoEstoque });

        await addDoc(colMov, movDoc);

        fecharModalMov();
      } catch (err) {
        console.error("Erro ao salvar movimenta√ß√£o:", err);
        alert("Erro ao salvar movimenta√ß√£o. Veja o console para detalhes.");
      }
    });

    // Excluir movimenta√ß√£o (com ajuste de estoque para Entrada/Sa√≠da)
    async function excluirMovimentacao(mov) {
      const item = itensCache.find(i => i.id === mov.itemId);
      const msgBase = `Deseja excluir esta movimenta√ß√£o?\n\n${mov.tipo} de ${mov.quantidade} un. do item ${mov.codigo} - ${mov.descricao}`;
      let msg = msgBase;

      if (mov.tipo === "Ajuste") {
        msg += "\n\nObs: Ajuste N√ÉO ir√° alterar o estoque atual ao excluir, para n√£o bagun√ßar o hist√≥rico.";
      } else {
        msg += "\n\nO estoque ser√° ajustado automaticamente ao excluir.";
      }

      const ok = confirm(msg);
      if (!ok) return;

      try {
        if (item && mov.tipo !== "Ajuste") {
          let novoEstoque = Number(item.estoque || 0);
          const qtd = Number(mov.quantidade || 0);

          if (mov.tipo === "Entrada") {
            novoEstoque -= qtd; // desfaz entrada
          } else if (mov.tipo === "Sa√≠da") {
            novoEstoque += qtd; // desfaz sa√≠da
          }

          const itemRef = doc(db, "itens_almox", item.id);
          await updateDoc(itemRef, { estoque: novoEstoque });
        }

        const movRef = doc(db, "movimentacoes_almox", mov.id);
        await deleteDoc(movRef);
      } catch (err) {
        console.error("Erro ao excluir movimenta√ß√£o:", err);
        alert("Erro ao excluir movimenta√ß√£o. Veja o console para detalhes.");
      }
    }

    // In√≠cio
    setView("itens");
    limparSelecao();
  </script>
</body>
</html>
